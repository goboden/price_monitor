# Сервис мониторинга цен на товары интернет-магазинов.

Сервис позволяет зарегистрированным пользователям сохранять ссылки на товары, и получать уведомления, если цена товара изменилась.

## Состав сервиса

1. База данных. Хранит данные сервиса. Предоставляет интефейс для доступа к данным для других модулей сервиса. 
1. Парсер. Предоставляет интерфейс для получения информации о товаре по ссылке на сраницу в магазине. 
1. Бот. Позволяет пользователям взаимодействовать с сервисом (регистрация, сохранение ссылок, получение пароля к веб-интерфейсу). Предоставляет интерфейс для отправки уведомлений.
1. Веб-интерфейс. Позволяет пользователям просматривать сохраненные ссылки и историю изменения цен.
1. Бэкенд. Поволяет выполнять обновление цен на товары в автоматическом и ручном режимах.

## Типовой сценарий работы с сервисом

1. Регистрация пользователя в сервисе. Отправка боту команды ```/start```.
1. Добавление ссылки на товар. Отпавка ссылки боту.
1. Получение пароля для доступа к веб-интерфейсу. Отправка боту команды ```/password```.
1. Вход в веб-интерфейс. Просмотр добавленных товаров и истории изменения цен.
1. Получение уведомлений при изменении цен.

## Запуск

Для запуска сервиса необходимо выполнить следующие шаги:

* Настроить базу данных
* Настроить парсер
* Настроить бота
* Настроить веб-интерфейс

* Запустить бота
* Запустить веб-интерфейс
* Запустить бэкенд

Детальное описание настройки и запуска модулей приведено ниже.

___

## База данных

### Размещение

```./database```

```decorators.py, exceptions.py, config.py```

### Настройка

Путь к базе данных задается в переменной DB_URI в файле ```config.py```

Создание базы данных

```
python -m database --create
```

Удаление базы данных

```
python -m database --drop
```

___

## Парсер

### Размещение

```./url_parser```

### Настройка

В директории модуля необходимо создать файл ```secret.py```. В нем указать значение констант:
* ```YANDEX_COOKIE_SPRAVKA = '...'``` (cookie 'spravka') 
* ```YANDEX_UID = '...'``` (cookie 'yandexuid')

Значения констант можно взять в браузере из cookies для https://market.yandex.ru/.

___

## Бот

Для работы необходимы:
* база данных
* парсер

### Размещение

```./telebot```

### Настройка

В директории бота необходимо создать файл ```secret.py```. В нем указать значение константы:

```API_KEY = '...'``` (токен для доступа к API Telegram).

### Запуск

```
python -m telebot --start
```

___

## Бэкенд

Для работы необходимы:
* база данных
* парсер
* бот

### Размещение

```./backend```

```decorators.py, exceptions.py, tasks.py```

### Настройка

Для работы автоматического обновления цен необходимо установить и запустить redis.

### Запуск

Ручное обновление цен на все товары пользователей

```
python -m backend --price-update
```

Запуск автоматического обновления цен на все товары пользователей по расписанию

#### Вариант 1:

В первом терминале:

```
celery -A tasks worker --loglevel=INFO -E
```

Во втором терминале:

```
celery -A tasks beat
```

#### Вариант 2:

```
celery -A tasks worker -B --loglevel=INFO -E
```

___

## Веб-интерфейс

Для работы необходимы:
* база данных
* бэкенд

### Размещение

```./webapp```

### Настройка

Установить значение переменной окружения ```FLASK_APP=webapp```

### Запуск

```
flask run
```
